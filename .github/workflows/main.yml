name: UBUNTU-WAYDROID-RDP-LIGHT

on:
  workflow_dispatch:

jobs:
  waydroid-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      # -------------------------------------------------
      # 1. Core utils
      # -------------------------------------------------
      - name: Update system & install core utils
        run: |
          sudo apt update
          sudo apt upgrade -y
          sudo apt install -y curl wget gnupg lsb-release software-properties-common netcat-openbsd ca-certificates

      # -------------------------------------------------
      # 2. Install lightweight Xfce + XRDP
      # -------------------------------------------------
      - name: Install Xfce + XRDP
        run: |
          sudo apt install -y xfce4 xfce4-goodies xorg xrdp
          sudo adduser xrdp ssl-cert

          # Set Xfce session in skeleton
          echo "xfce4-session" | sudo tee /etc/skel/.xsession > /dev/null

          sudo systemctl restart xrdp
          sudo systemctl enable xrdp
          sudo ufw allow 3389/tcp || true
          sudo ufw --force enable || true

      # -------------------------------------------------
      # 3. Install Waydroid via OFFICIAL SCRIPT (fixes repo error)
      # -------------------------------------------------
      - name: Install Waydroid from official script
        run: |
          # Run the official setup script (auto-detects Ubuntu 24.04/noble)
          curl https://repo.waydro.id | sudo bash
          
          # If auto-detection fails (rare), fallback with manual distro flag
          # curl https://repo.waydro.id | sudo bash -s noble
          
          # Update & install Waydroid + kernel extras
          sudo apt update
          sudo apt install -y waydroid linux-modules-extra-$(uname -r)

          # Load kernel modules
          sudo modprobe binder_linux
          sudo modprobe ashmem_linux
          echo "binder_linux" | sudo tee -a /etc/modules-load.d/waydroid.conf
          echo "ashmem_linux" | sudo tee -a /etc/modules-load.d/waydroid.conf

      # -------------------------------------------------
      # 4. Create RDP user (random password)
      # -------------------------------------------------
      - name: Create RDP user
        run: |
          chars_upper=$(cat /dev/urandom | tr -dc 'A-Z' | head -c4)
          chars_lower=$(cat /dev/urandom | tr -dc 'a-z' | head -c4)
          chars_num=$(cat /dev/urandom | tr -dc '0-9' | head -c4)
          chars_spec=$(cat /dev/urandom | tr -dc '!@#$%^&*()_+-=' | head -c4)
          password=$(echo "$chars_upper$chars_lower$chars_num$chars_spec" | fold -w1 | shuf | tr -d '\n')

          username="tahir"
          sudo adduser --disabled-password --gecos "" $username
          echo "$username:$password" | sudo chpasswd
          sudo usermod -aG sudo $username

          # Copy .xsession to user
          sudo cp /etc/skel/.xsession /home/$username/.xsession
          sudo chown $username:$username /home/$username/.xsession

          echo "RDP_USER=$username" >> $GITHUB_ENV
          echo "RDP_PASS=$password" >> $GITHUB_ENV

      # -------------------------------------------------
      # 5. Initialise Waydroid
      # -------------------------------------------------
      - name: Initialise Waydroid
        run: |
          sudo waydroid init -f
          sudo systemctl restart waydroid-container
          sleep 10
          sudo waydroid session start &

          timeout=90
          while [ $timeout -gt 0 ]; do
              if waydroid status | grep -q "RUNNING"; then
                  echo "Waydroid container is RUNNING"
                  break
              fi
              sleep 5
              timeout=$((timeout - 5))
          done
          [ $timeout -le 0 ] && { echo "Waydroid did not start"; exit 1; }

      # -------------------------------------------------
      # 6. Tailscale
      # -------------------------------------------------
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Connect via Tailscale
        run: |
          hostname="waydroid-$GITHUB_RUN_ID"
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
                             --hostname=$hostname \
                             --accept-routes \
                             --accept-dns=false

          retries=0
          tsIP=""
          while [ -z "$tsIP" ] && [ $retries -lt 30 ]; do
              tsIP=$(sudo tailscale ip --4)
              [ -n "$tsIP" ] && break
              echo "Waiting for Tailscale IP… ($retries)"
              sleep 5
              retries=$((retries + 1))
          done
          [ -z "$tsIP" ] && { echo "Tailscale IP not obtained"; sudo tailscale status; exit 1; }

          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "TAILSCALE_HOST=$hostname" >> $GITHUB_ENV

      # -------------------------------------------------
      # 7. Verify RDP
      # -------------------------------------------------
      - name: Verify RDP & Waydroid
        run: |
          echo "=== CONNECTION INFO ==="
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASS"
          waydroid status

          nc -zv localhost 3389 || { echo "RDP port 3389 not open locally"; exit 1; }
          nc -zv $TAILSCALE_IP 3389 || { echo "RDP not reachable over Tailscale"; exit 1; }
          echo "RDP is reachable!"

      # -------------------------------------------------
      # 8. Auto‑start Waydroid UI
      # -------------------------------------------------
      - name: Auto-start Waydroid UI
        run: |
          mkdir -p /home/$RDP_USER/.config/autostart
          cat <<EOF > /home/$RDP_USER/.config/autostart/waydroid.desktop
          [Desktop Entry]
          Type=Application
          Name=Waydroid Full UI
          Exec=waydroid show-full-ui
          X-GNOME-Autostart-enabled=true
          EOF
          sudo chown -R $RDP_USER:$RDP_USER /home/$RDP_USER/.config

      # -------------------------------------------------
      # 9. Keep alive + instructions
      # -------------------------------------------------
      - name: Keep alive & show instructions
        run: |
          echo "=================================================="
          echo "          WAYDROID + LIGHT RDP READY"
          echo "=================================================="
          echo "1. Install Tailscale on Windows → login"
          echo "2. Windows RDP (mstsc) → $TAILSCALE_IP"
          echo "   Username: $RDP_USER"
          echo "   Password: $RDP_PASS"
          echo ""
          echo "Inside Xfce → Android UI auto‑starts or run:"
          echo "   waydroid show-full-ui"
          echo "=================================================="

          while true; do
              echo "[$(date)] RDP + Waydroid active – cancel workflow to stop"
              sleep 300
          done
