name: UBUNTU-WAYDROID-RDP-LIGHT

on:
  workflow_dispatch:

jobs:
  waydroid-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      # -------------------------------------------------
      # 1. Basic system update
      # -------------------------------------------------
      - name: Update system & install core utils
        run: |
          sudo apt update
          sudo apt upgrade -y
          sudo apt install -y curl wget gnupg lsb-release software-properties-common netcat-openbsd

      # -------------------------------------------------
      # 2. Install **lightweight** desktop (Xfce) + XRDP
      # -------------------------------------------------
      - name: Install Xfce + XRDP
        run: |
          sudo apt install -y xfce4 xfce4-goodies xorg xrdp
          sudo adduser xrdp ssl-cert
          # Use Xfce session for XRDP
          echo "xfce4-session" > /etc/skel/.xsession
          sudo systemctl restart xrdp
          sudo systemctl enable xrdp
          sudo ufw allow 3389/tcp || true
          sudo ufw --force enable || true

      # -------------------------------------------------
      # 3. Add **official** Waydroid PPA & install
      # -------------------------------------------------
      - name: Add Waydroid PPA & install
        run: |
          sudo add-apt-repository -y ppa:waydroid/ppa
          sudo apt update
          sudo apt install -y waydroid linux-modules-extra-$(uname -r)

          # Load binder/ashmem (required by Waydroid)
          sudo modprobe binder_linux
          sudo modprobe ashmem_linux
          echo "binder_linux" | sudo tee -a /etc/modules-load.d/waydroid.conf
          echo "ashmem_linux" | sudo tee -a /etc/modules-load.d/waydroid.conf

      # -------------------------------------------------
      # 4. Create RDP user (random strong password)
      # -------------------------------------------------
      - name: Create RDP user
        run: |
          chars_upper=$(cat /dev/urandom | tr -dc 'A-Z' | head -c4)
          chars_lower=$(cat /dev/urandom | tr -dc 'a-z' | head -c4)
          chars_num=$(cat /dev/urandom | tr -dc '0-9' | head -c4)
          chars_spec=$(cat /dev/urandom | tr -dc '!@#$%^&*()_+-=' | head -c4)
          password=$(echo "$chars_upper$chars_lower$chars_num$chars_spec" | fold -w1 | shuf | tr -d '\n')

          username="tahir"
          sudo adduser --disabled-password --gecos "" $username
          echo "$username:$password" | sudo chpasswd
          sudo usermod -aG sudo $username

          # Give the user an Xfce session file
          sudo mkdir -p /home/$username
          sudo cp /etc/skel/.xsession /home/$username/.xsession
          sudo chown $username:$username /home/$username/.xsession

          echo "RDP_USER=$username" >> $GITHUB_ENV
          echo "RDP_PASS=$password" >> $GITHUB_ENV

      # -------------------------------------------------
      # 5. Initialise Waydroid container
      # -------------------------------------------------
      - name: Initialise Waydroid
        run: |
          sudo waydroid init -f
          sudo systemctl restart waydroid-container
          sleep 10
          sudo waydroid session start &

          # Wait until container reports RUNNING (max 90 s)
          timeout=90
          while [ $timeout -gt 0 ]; do
              if waydroid status | grep -q "RUNNING"; then
                  echo "Waydroid container is RUNNING"
                  break
              fi
              sleep 5
              timeout=$((timeout - 5))
          done
          [ $timeout -le 0 ] && { echo "Waydroid did not start"; exit 1; }

      # -------------------------------------------------
      # 6. Install Tailscale
      # -------------------------------------------------
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      # -------------------------------------------------
      # 7. Connect via Tailscale
      # -------------------------------------------------
      - name: Connect via Tailscale
        run: |
          hostname="waydroid-$GITHUB_RUN_ID"
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
                             --hostname=$hostname \
                             --accept-routes \
                             --accept-dns=false

          # Wait for IPv4 address
          retries=0
          tsIP=""
          while [ -z "$tsIP" ] && [ $retries -lt 30 ]; do
              tsIP=$(sudo tailscale ip --4)
              [ -n "$tsIP" ] && break
              echo "Waiting for Tailscale IP… ($retries)"
              sleep 5
              retries=$((retries + 1))
          done
          [ -z "$tsIP" ] && { echo "Tailscale IP not obtained"; sudo tailscale status; exit 1; }

          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "TAILSCALE_HOST=$hostname" >> $GITHUB_ENV

      # -------------------------------------------------
      # 8. Verify RDP port is reachable
      # -------------------------------------------------
      - name: Verify RDP & Waydroid
        run: |
          echo "=== CONNECTION INFO ==="
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASS"
          waydroid status

          if ! nc -zv localhost 3389; then
              echo "RDP port 3389 not open locally"
              exit 1
          fi
          if ! nc -zv $TAILSCALE_IP 3389; then
              echo "RDP not reachable over Tailscale"
              exit 1
          fi
          echo "RDP is reachable!"

      # -------------------------------------------------
      # 9. (Optional) Auto-start Waydroid UI on login
      # -------------------------------------------------
      - name: Auto-start Waydroid UI for the user
        run: |
          mkdir -p /home/$RDP_USER/.config/autostart
          cat <<EOF > /home/$RDP_USER/.config/autostart/waydroid.desktop
          [Desktop Entry]
          Type=Application
          Name=Waydroid Full UI
          Exec=waydroid show-full-ui
          X-GNOME-Autostart-enabled=true
          EOF
          chown -R $RDP_USER:$RDP_USER /home/$RDP_USER/.config

      # -------------------------------------------------
      # 10. Keep workflow alive & print instructions
      # -------------------------------------------------
      - name: Keep alive & show instructions
        run: |
          echo "=================================================="
          echo "          WAYDROID + LIGHT RDP READY"
          echo "=================================================="
          echo "1. Install Tailscale on Windows: https://tailscale.com/download"
          echo "2. Log in with the same Tailscale account"
          echo "3. Open Windows RDP (mstsc.exe) → connect to: $TAILSCALE_IP"
          echo "   Username: $RDP_USER"
          echo "   Password: $RDP_PASS"
          echo ""
          echo "Once inside the Xfce desktop:"
          echo "   • Open Terminal → run:  waydroid show-full-ui"
          echo "   • Or it will auto-start (see step 9)"
          echo "=================================================="

          while true; do
              echo "[$(date)] RDP + Waydroid active – cancel workflow to stop"
              sleep 300
          done
